/**
 * Copyright (C) 2019 New York City Department of Health and Mental Hygiene, Bureau of Immunization
 * Contributions by HLN Consulting, LLC
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the GNU
 * Lesser General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version. You should have received a copy of the GNU Lesser
 * General Public License along with this program. If not, see <http://www.gnu.org/licenses/> for more
 * details.
 *
 * The above-named contributors (HLN Consulting, LLC) are also licensed by the New York City
 * Department of Health and Mental Hygiene, Bureau of Immunization to have (without restriction,
 * limitation, and warranty) complete irrevocable access and rights to this project.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; THE
 *
 * SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING,
 * BUT NOT LIMITED TO, WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE COPYRIGHT HOLDERS, IF ANY, OR DEVELOPERS BE LIABLE FOR
 * ANY CLAIM, DAMAGES, OR OTHER LIABILITY OF ANY KIND, ARISING FROM, OUT OF, OR IN CONNECTION WITH
 * THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * For more information about this software, see http://www.hln.com/ice or send
 * correspondence to ice@hln.com.
 */
 
package org.cdsframework.ice.v1_1_0

import java.util.Date
import java.util.List
import java.util.Set
import org.drools.spi.KnowledgeHelper
import org.opencds.vmr.v1_0.internal.EvalTime
import org.opencds.vmr.v1_0.internal.EvaluatedPerson
import org.cdsframework.ice.service.DiseaseImmunity
import org.cdsframework.ice.service.DoseStatus
import org.cdsframework.ice.service.ICEFactTypeFinding
import org.cdsframework.ice.service.ICELogicHelper
import org.cdsframework.ice.service.Recommendation
import org.cdsframework.ice.service.RecommendationStatus
import org.cdsframework.ice.service.SeriesRules
import org.cdsframework.ice.supportingdatatmp.SupportedFactConcept
import org.cdsframework.ice.service.TargetDose
import org.cdsframework.ice.service.TargetSeries
import org.cdsframework.ice.util.TimePeriod
import org.cdsframework.ice.util.TimePeriod.DurationType
import org.cdsframework.ice.service.Vaccine

expander ../org.cdsframework^ICE^1.0.0/org.cdsframework^ICE^1.0.0.dsl

global java.util.Date evalTime
global org.drools.runtime.KnowledgeContext kcontext


/*************************************************************************************************************************************************************************************
Rules for Recurring Td (CVX 09)
Once the patient has completed the primary DTP series (3-dose or 5-dose) and has received a dose of pertussis at >= 7 years of age, a Td (09) is needed every 10 years.  

Evaluation Rules for Recurring Td
    + All vaccines in the DTP vaccine group are allowed for the recurring Td.
    + Minimum interval = 0 days 
    + Once the primary series is complete and the patient has a dose of pertussis at >=7, any DTP shot is evaluated as VALID for the recurring Td.
*************************************************************************************************************************************************************************************/

// Rules for Recurring Td (CVX 09) 
// Once the patient has completed the primary DTP series (3-dose or 5-dose) and has received a dose of pertussis at >= 7 years of age, a Td (09) is needed every 10 years.
// All vaccines in the DTP vaccine group are allowed for the recurring Td.
// Once the primary series is complete and the patient has a dose of pertussis at >=7, any DTP shot is evaluated as VALID for the recurring Td.  
rule "DTP: Evaluate recurring Td as valid if Td (age) evaluation criteria is met" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "doseAgeCheck"	// Prevent default series interval rule from firing, which would mark this shop as ACCEPTED/EXTRA_DOSE instead of simply valid.
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- make note of the administered shot number as $currentShotNumber
			- make note of the Associated Series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the series is complete
		The Patient information $evaluatedPerson must be known to complete writing this rule
			 - make note of the date as $dtDateAtAge when the patient is "7y" of age
		There exists an IceFact
			- that has finding SupportedFactConcept._DOSE_OF_PERTUSSIS.conceptCodeValue
			- there is an associated administered shot in the Series $targetSeries as well as IceResult administration date >= $dtDateAtAge
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries	
end


// Interval check for recurring Td. Minimum interval = 0 days 
rule "DTP: Evaluate recurring Td as valid if Td (interval) evaluation criteria is met" extends "DTP: Evaluate recurring Td as valid if Td (age) evaluation criteria is met"
	ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "doseIntervalCheck" // This activation-group prevents the default series interval rule from firing, which would mark this shop as ACCEPTED/EXTRA_DOSE instead of simply valid.
	when
		// Since the absolute minimum interval is 0 days, no actual interval check performed.
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries	
end


// Interval check for recurring Td. Minimum interval = 0 days 
rule "DTP: Override default series rule that evaluates extra Td shots in the series as accepted" extends "DTP: Evaluate recurring Td as valid if Td (age) evaluation criteria is met"
	ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "extraDoseCheck" // This activation-group prevents the default series interval rule from firing, which would mark this shop as ACCEPTED/EXTRA_DOSE instead of simply valid.
	when
		// Since the absolute minimum interval is 0 days, no actual interval check performed.
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries	
end

/*************************************************************************************************************************************************************************************
Rules for Recurring Td (CVX 09) END
*************************************************************************************************************************************************************************************/


rule "DTP: Evaluate Adolescent Tdap shot as valid if Tdap (age) evaluation critera is met" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "doseAgeCheck"
	when
		There is an IceFact $iceResultFinding
			- that has finding SupportedFactConcept._DOSE_OF_ADOLESCENT_TDAP_NEEDED.conceptCodeValue
		The patient information $patientInformation must be known to complete writing this rule
			- make note of the date as $dtDateAtAge when the patient is "7y" of age
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the administration date of the shot is >= $dtDateAtAge
			- make note of the diseases targeted by the vaccine administered as $diseasesTargetedByThisShot
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.033.9"
			- make note of the Associated Series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the series is complete
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "DTP: Evaluate Adolescent Tdap shot as valid if Tdap (interval) evaluation critera is met" extends "DTP: Evaluate Adolescent Tdap shot as valid if Tdap (age) evaluation critera is met" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "doseIntervalCheck"
	when
		// Extension of Age rule to prevent default series inteval rule from firing
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "DTP: Override default series rule that evaluates extra Tdap shots in the series as accepted" extends "DTP: Evaluate Adolescent Tdap shot as valid if Tdap (age) evaluation critera is met" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		// Extension of Age rule to prevent default series interval rule from firing
	then
		Include the reason for shot $currentShotValid Valid
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


/*************************************************************************************************************************************************************************************
// A dose of pertussis is defined as one of the following:
//     * A primary series (3-dose series or 5-dose series) dose of CVX 01, 20, 106, 107, or 115
//     * A primary series shot of CVX 01, 20, 106, 107, or 115 where the shot is evaluated as Invalid with a reason code of D_AND_T_INVALID/P_VALID 
//     * An Adolescent Tdap dose of CVX 01, 20, 106, 107, or 115    (adolescent Tdap series is if series is complete and patient >= 7yrs)
*************************************************************************************************************************************************************************************/

rule "DTP(1): A primary series dose of pertussis exists if a (valid) dose of Pertussis was administered" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	auto-focus true
	when
		There is an administered shot $currentShot
			- that has already been evaluated and whose shot validity is VALID
			- make note of the diseases targeted by the vaccine administered as $diseasesTargetedByThisShot
			- the shot belongs to the primary series
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.033.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.032.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.037"
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200"
		There is not an IceFact
			- that has finding SupportedFactConcept._DOSE_OF_PERTUSSIS.conceptCodeValue
			- that has associated administered shot $currentShot
	then
		Insert an IceFact SupportedFactConcept._DOSE_OF_PERTUSSIS.getConceptCodeValue() with TargetDose $currentShot into working memory
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot
end


rule "DTP(2): A primary series dose of pertussis exists if a shot that was evaluated as Invalid with a reason code of D_AND_T_INVALID/P_VALID" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	auto-focus true
	when
		There is an administered shot $currentShot
			- that has already been evaluated and whose shot validity is INVALID
			- make note of all evaluation reasons for this shot as $collectionOfStrReasons
			- the shot belongs to the primary series
			- the collection $collectionOfStrReasons contains "EVALUATION_REASON_CONCEPT.D_AND_T_INVALID/P_VALID"
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200"
		There is not an IceFact
			- that has finding SupportedFactConcept._DOSE_OF_PERTUSSIS.conceptCodeValue
			- that has associated administered shot $currentShot
	then
		Insert an IceFact SupportedFactConcept._DOSE_OF_PERTUSSIS.getConceptCodeValue() with TargetDose $currentShot into working memory
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot
end


rule "DTP(3): A primary dose of pertussis exists if a (valid) dose for adolescent Tdap was administered" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	auto-focus true
	when
		The Patient information $evaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge when the patient is "7y" of age	
		There is an administered shot $currentShot
			- that has already been evaluated and whose shot validity is VALID
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200"
			- make note of the diseases targeted by the vaccine administered as $diseasesTargetedByThisShot
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.033.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.032.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.037"
			- the administration date of the shot is >= $dtDateAtAge
			- make note of the Associated Series as $associatedTargetSeries
		There is not an IceFact
			- that has finding SupportedFactConcept._DOSE_OF_PERTUSSIS.conceptCodeValue
			- that has associated administered shot $currentShot
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the series is complete
	then
		Insert an IceFact SupportedFactConcept._DOSE_OF_PERTUSSIS.getConceptCodeValue() with TargetDose $currentShot into working memory
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot
end

/*************************************************************************************************************************************************************************************
Definition of "A dose of pertussis" END
/************************************************************************************************************************************************************************************/


// The absolute minimum age1 for Tdap (CVX 115) and Td (CVX 09, 113, 138, 139) applies when Tdap/Td is given as target dose 1, 2, or 3 in the 5-dose series.
//     * If Tdap/Td is administered below the CVX code absolute minimum age, then the Evaluation is Invalid and the reason code is INSUFFICIENT_ANTIGEN.
rule "DTP: Absolute Minimum Age for Tdap/Td applies for target doses 1-3 of the 5-dose series when certain conditions are true" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "minimumAgeVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200" and the Series with name "DTP5DoseSeries"
			- the dose number in the series is <= 3
			- the vaccine administered a member of ("ICE115", "ICE09", "ICE113", "ICE138", "ICE139")
			- make note of the minimum vaccine age for this shot as $strValidMinimumAge
			- make note of the Date this Shot was Administered as $administrationDate
			- make note of the Associated Series as $associatedTargetSeries
		The Patient information $evaluationPerson must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthdate
		Confirm elapsed time between $birthdate and $administrationDate < $strValidMinimumAge
	then
		Include the reason for shot $currentShot Invalid due to "Insufficient Antigen"
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


// The absolute minimum age1 does not apply when Tdap (CVX 115) or Td (CVX 09, 113, 138, 139) is administered as target dose 4 or 5 in the 5-dose series. 
//     * The absolute minimum age is only waived when the target dose is a true dose 4 or 5; the waiver does not apply when dose 1 was skipped. 
//// TODO: FIX
rule "DTP: Absolute Minimum Age for Tdap/Td check for target doses 4 or 5 of the 5-dose series" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200" and the Series with name "DTP5DoseSeries"
			- the dose number in the series is one of (4,5)
			- the vaccine administered a member of ("ICE115", "ICE09", "ICE113", "ICE138", "ICE139")
			- make note of the Associated Series as $associatedTargetSeries
	then
		// Simply log that this occurred
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end
			
			
rule "DTP: Absolute Minimum Age for Tdap/Td does not apply for true target dose 4 or 5 of the 5-dose for 5-dose series if 5-dose Exception #1 did not occur" extends "DTP: Absolute Minimum Age for Tdap/Td check for target doses 4 or 5 of the 5-dose series"
	ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "minimumAgeVaccineCheck"
	when
		There is not an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._DTP_5_DOSE_SERIES_EXCEPTION1.conceptCodeValue
	then
		// Minimum age for vaccine is waived - Simply log that this occurred
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end
		
		
rule "DTP: Absolute Minimum Age for Tdap/Td does not apply for true target dose 4 or 5 of the 5-dose for 5-dose series if 5-dose Exception #2 did not occur" extends "DTP: Absolute Minimum Age for Tdap/Td check for target doses 4 or 5 of the 5-dose series"
	ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	activation-group "minimumAgeVaccineCheck"
	when
		There is not an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._DTP_5_DOSE_SERIES_EXCEPTION2.conceptCodeValue
	then
		// Minimum age for vaccine is waived - Simply log that this occurred
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


// CVX Code Minimum Interval Between Tdap/DTaP and Td/DT
// If Tdap (CVX 115), DTaP (CVX 20, 106, or 107), or DTP (CVX 01) is given below the minimum interval from a Td (CVX 09, 113, 138, 139) or DT (CVX 28), but the shot meets the 
// minimum age, then the Tdap/DTaP/DTP is evaluated as Invalid and the reason code is D_AND_T_INVALID/P_VALID  (i.e., Diphtheria and tetanus components invalid due to minimum 
// interval violation, pertussis component valid).
rule "DTP: Enforce Minimum Interval between Tdap/DTaP and Td/DT if the shot meets the minimum age" ruleflow-group "HistoryEvaluation"
	agenda-group "postEvaluationCheck"
	no-loop true
	dialect "mvel"
	when
		There is an Administered Shot $currentShot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200"
			- the administered shot number is >= 2
			- make note of the administered shot number as $nAdministeredShotNumber
			- make note of the diseases targeted by the vaccine administered as $diseasesTargetedByThisShot
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.033.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.032.9"
			- the collection $diseasesTargetedByThisShot contains "SUPPORTED_DISEASE_CONCEPT.037"
			- make note of the associated series as $targetSeries
		There is an Administered Shot $administeredPrior
			- the shot belongs to the Series $targetSeries
			- the administered shot number is == ($nAdministeredShotNumber-1)
			- make note of the diseases targeted by the vaccine administered as $diseasesTargetedByPriorShot
			- the collection $diseasesTargetedByPriorShot contains "SUPPORTED_DISEASE_CONCEPT.032.9"
			- the collection $diseasesTargetedByPriorShot contains "SUPPORTED_DISEASE_CONCEPT.037"
			- the collection $diseasesTargetedByPriorShot does not contain "SUPPORTED_DISEASE_CONCEPT.033.9"
		There is not an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_AGE.conceptCodeValue
		There is not an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._INVALID_VACCINE.conceptCodeValue
		There is an IceFact $ICEFactTypeFinding
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
	then
		Remove Evaluation Reason "EVALUATION_REASON_CONCEPT.BELOW_MINIMUM_INTERVAL" from Shot $currentShot
		Include the reason for shot $currentShot Invalid due to "D_AND_T_INVALID/P_VALID"
		Refresh all Facts in the Series $targetSeries for Evaluation
		Refresh all Facts in the Shot $currentShot
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


/*************************************************************************************************************************************************************************************
5-Dose Series Special Rules 
Rule for Recommending/Evaluating Next Dose From Invalid Tdap/TD Given Below Minimum Age for Vaccine
If Tdap (CVX 115) or Td (CVX 09, 113, 138, 139) is given as target dose 1, 2 or 3 to a patient <7 years - 4 days old, then the invalid shot should be ignored when determining 
the next target dose due and when evaluating the next shot based on the minimum interval for that target dose.
*************************************************************************************************************************************************************************************/

rule "DTP(HistoryEvaluation): If Tdap (CVX 115) or Td (CVX 09, 113, 138, 139) is administered as target dose 1, 2 or 3 to a patient < 7yrs-4days, shot should be ignored when calculating intervals" ruleflow-group "HistoryEvaluation"
	agenda-group "customEvaluationRule"
	when
		// The shot being evaluated
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.200" and the Series with name "DTP5DoseSeries"
			- the dose number in the series is <= 3
			- the vaccine administered a member of ("ICE115", "ICE09", "ICE113", "ICE138", "ICE139")
			- make note of the date this shot was administered as $administrationDate
			- make note of the minimum vaccine age for this Shot as $validMinimumAgeVaccine
			- make note of the associated series as $associatedTargetSeries
		The Patient information $evaluatedPerson must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthdate
		// Check that Td or Tdap was admininstered < 7y-4d of age
		Confirm elapsed time between $birthdate and $administrationDate < $validMinimumAgeVaccine
	then
		Mark the shot $currentShot as Ignored
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
5-Dose Series Special Rules END
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
5-dose Series Exception Rules
The 5-dose series above applies unless:

Exception 1: Series Complete with 3 Doses
    * If the patient is >=7, received the first dose at >= 12 months of age, and received at least one dose at >= 4 years1 of age, then the 
      series is complete with 3 doses (doses 2, 3 and 4).
      
Exception 2: Series Complete with 4 Doses
    * If 4 doses have been administered and the 4th dose is administered at >= 4 years of age, then the series is complete with 4 doses; the 5th (booster) dose is not needed.
 *************************************************************************************************************************************************************************************/

rule "DTP: (5-Dose Series Exception Rule 1)- Mark the 5-Dose Series Complete for Patient >=7 yrs if 3 doses have been administered, with the first dose at >= 12m and at least 1 dose at >= 4yrs" 
 	ruleflow-group "HistoryEvaluation"
 	agenda-group "postEvaluationCheck"
 	dialect "mvel"
 	when
		There is a Series $targetSeries
			- the series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the series is not complete
			- the name of the series is "DTP5DoseSeries"
			- the number of doses administered is == 3
		The Patient information $assign_oEvaluatedPerson must be known to complete writing this rule
			- make note of the Patient's birthdate as $birthdate
			- make note of the date as $dtDateAtAge4y when the patient is "4y" of age
			- make note of the date as $dtDateAtAge12m when the patient is "12m" of age
		There exists an Administered Shot
			- the shot belongs to the Series $targetSeries
			- that has already been evaluated and whose Shot Validity is VALID
			- the Administration Date of the shot is >= $dtDateAtAge12m
			- the Dose Number in the Series is == 1
		There exists an Administered Shot
			- the shot belongs to the Series $targetSeries
			- that has already been evaluated and whose Shot Validity is VALID
			- the Administration Date of the shot is >= $dtDateAtAge4y
			- the Dose Number in the Series is >= 2
		There is an Administered Shot $thirdDose
			- the shot belongs to the Series $targetSeries
			- the Dose Number in the Series is == 3
			- that has already been evaluated and whose Shot Validity is VALID
			- make note of the date this shot was administered as $dtDateThirdDose
		Confirm elapsed time between $birthdate and $dtDateThirdDose >= "7y"
 	then
 		Mark the Series $targetSeries Complete
		Refresh all Facts in the Series $targetSeries for Evaluation
		Insert an IceFact SupportedFactConcept._DTP_5_DOSE_SERIES_EXCEPTION1.getConceptCodeValue() into working memory
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end
 
 
rule "DTP: (5-Dose Series Exception Rule 2)- Mark the 5-Dose Series Complete if 4 Doses have been Administered and the 4th Dose is Administered at >= 4 yrs of age" 
 	ruleflow-group "HistoryEvaluation"
 	agenda-group "postEvaluationCheck"
 	dialect "mvel"
 	when
		There is a Series $targetSeries
			- the series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.200"
			- the series is not complete
			- the name of the series is "DTP5DoseSeries"
			- the number of doses administered is == 4
		The Patient information $assign_oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge when the patient is "4y" of age
		There is an Administered Shot $dose4
			- the shot belongs to the Series $targetSeries
			- the dose number in the series is == 4
			- the Administration Date of the shot is >= $dtDateAtAge
 	then
 		Mark the Series $targetSeries Complete
 		Insert an IceFact SupportedFactConcept._DTP_5_DOSE_SERIES_EXCEPTION2.getConceptCodeValue() into working memory
		Refresh all Facts in the Series $targetSeries for Evaluation
		Record that this Series Rule was Processed for the TargetSeries $targetSeries
		Log that this Series Rule fired for the Series $targetSeries
end
 
/*************************************************************************************************************************************************************************************
5-Dose Series Exception Rules END
/************************************************************************************************************************************************************************************/

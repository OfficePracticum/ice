variables:
  MAVEN_OPTS: -Dmaven.repo.local=/root/.m2

stages:
  - deploy
  - build-knowledge
  - build-ice
  - upload

s3-deploy:
  image: registry.gitlab.com/gitlab-org/cloud-deploy/aws-base:latest
  stage: deploy
  environment:
    name: dev
  script:
    - >
      rm -rf /tmp/ice
      mkdir -p /tmp/ice
      cp -r ice3/opencds-ice-service/src/main/resources/* /tmp/ice
      cd /tmp
      zip -r ice.zip ice

      aws s3 cp /tmp/ice.zip $S3_PATH --acl public-read
  only:
    - deployment

build-knowledge:
  image: maven:3-jdk-8-slim
  stage: build-knowledge
  script: "mvn -f opencds/opencds-knowledge-repository-data/pom.xml clean install -DskipTests -B -Dmaven.wagon.http.ssl.insecure=true"
  only:
    - deployment

build-ice:
  image: maven:3-jdk-8-slim
  stage: build-ice
  script: "mvn -f opencds/opencds-parent/pom.xml clean install -DskipTests -B -Dmaven.wagon.http.ssl.insecure=true"
  only:
    - deployment

#upload-knowledge-repo:
#  image: maven:3-jdk-8-slim
#  stage: upload
#  script: "mvn -f opencds/opencds-knowledge-repository-data/pom.xml deploy -DskipTests -B -Dmaven.wagon.http.ssl.insecure=true"
#  only:
#    - deployment

upload-ice-repo:
  image: maven:3-jdk-8-slim
  stage: upload
  script: "mvn -f ice3/opencds-ice-service/pom.xml deploy -DskipTests -B -Dmaven.wagon.http.ssl.insecure=true"
  only:
    - deployment


